<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casa Textil Interactiva</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: black;
            overflow: hidden;
            touch-action: none;
            font-family: Arial, sans-serif;
        }
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #casa {
            position: relative;
            width: 400px;
            height: 400px;
            background-color: transparent;
        }
        #casa svg {
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .grid-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 2;
        }
        .house-point {
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: transparent;
            transform: translate(-50%, -50%);
            cursor: move;
            z-index: 10;
        }
        #audioLevel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 100px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            overflow: hidden;
            display: none;
        }
        #audioLevelBar {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 0;
            background-color: rgba(255, 0, 0, 0.5);
            transition: height 0.1s;
        }
        #micPermission {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
        }
        .fragments {
            position: absolute;
            width: 100px;
            height: 100px;
            background-color: transparent;
            pointer-events: all;
            cursor: move;
            z-index: 5;
            display: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="casa">
            <div class="grid-overlay"></div>
            <svg viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                        <path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(200, 200, 200, 0.5)" stroke-width="0.5"/>
                    </pattern>
                </defs>
                <path id="housePath" fill="white" stroke="#A52A2A" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" d="M 200,50 L 300,150 L 300,300 L 250,300 L 250,250 L 150,250 L 150,300 L 100,300 L 100,150 Z"/>
                <path id="houseStitches" fill="none" stroke="#A52A2A" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="1, 5" d="M 200,50 L 300,150 L 300,300 L 250,300 L 250,250 L 150,250 L 150,300 L 100,300 L 100,150 Z"/>
            </svg>
        </div>
        <div id="audioLevel">
            <div id="audioLevelBar"></div>
        </div>
        <button id="micPermission">Habilitar micrófono para interactuar</button>
        <!-- Fragmentos para cuando la casa explota -->
        <div class="fragments" id="fragment1">
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <path fill="white" stroke="#A52A2A" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M 20,20 L 80,40 L 60,90 Z"/>
            </svg>
            <div class="grid-overlay"></div>
        </div>
        <div class="fragments" id="fragment2">
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <path fill="white" stroke="#A52A2A" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M 40,10 L 90,30 L 70,60 L 20,80 Z"/>
            </svg>
            <div class="grid-overlay"></div>
        </div>
        <div class="fragments" id="fragment3">
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <path fill="white" stroke="#A52A2A" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M 10,30 L 50,10 L 90,50 L 60,90 Z"/>
            </svg>
            <div class="grid-overlay"></div>
        </div>
        <audio id="popSound" preload="auto">
            <source src="data:audio/mpeg;base64,SUQzAwAAAAAAPlRQRTEAAAAcAAAAU291bmQgSmF5IFNvdW5kIEVmZmVjdHNUQ09OAAAAFAAAAFN0b2NrIHNvdW5kIGVmZmVjdAD/+5DEAAAToKJWhexgAAZCB0XA9wBgEQhCoGAwHAYBgnB4Pg+cHwfB8HwQhCDgMBADAIAwgPnB8HwfB8EIQg4DAQBPFD4vmQGAQBAEAW4gQwf8QPnv0gDwGD5/9/8R/xAGD/6gDAL4ofP+ID/iB8/+///Ef8f5QfB8HwSjcHwfB8EIQhADgMBAGALvBB4IQQCAQCC73oIAgEAgEB7iCCEAQPAjmH2QVBEEAQBD/8/aCAIBAIBAfkRDAH2xWVSSlkUlbGJZyKKEwSA0FAUCgbAYqlQBgoEwRBEBADiwGQqAzNYZSkNiqkYVkLhDZxaXWh+UWkpNpvvbNYHOcdzYqZFXI0CZWM4QAAMFwTAoIzHZfkIkMAzeFm2Vw6AZl6QgGCcHgGAWMSjDKMZZJGWwCGXC8UoMzGPMnQ9mczHWZLmvJKjW4VBdEHUCuVLUliiRQADqMNl9TqNjmEKBQAzaoLKBUMDxYGSALDChMQhsDHsNi5ODBIMAgRAwSFwYBAiDAX8M6hWDBcNT1fAIgWA8C5MKAXdQB4FwLAsNBdK+GDAMfCsC4FwLgWBYHaIRqXKqUyBOlZQjqYqTsJCLAyxaFtLTVkLNzPYnXHO1hjg4YN+9nY8NQ+lHTxKYmDGZVyMBY+HJ6FvTuXyH2qyKJyC7zNQ3RCmk1OnmXcrkvV3X/s7rdVlVvH/nUmfp/zvnZzdV+qrqdfN//9SZ7///u5qq/OzP5+quyuzOz/OzLs6VeU2+0JFuCp2f7/TmUmXZlZdprQzXcxRUZzDGZzcZvPqr3/LmZ1oY6//q7MxwEHI+QIcVZfMqNsLmqk1GX2iXpuqCYrEVbHdwbJCM63NRRTSRM6GG66HG36+XK9n6/0/gPl3M3PFJZK4QcfYKCAOQ9TiilMu5lEGIgq5wJqyKkCp1KUkJCiZEzB86JmcXlRtf6v7uyKNljapI0W1KJkRnq+YTOj5hKIZ0XO7u9FzMzN6ERY1lHvkqiP//+xJwxWRDBQB8sZfgIgYEAPgjL8RAwFAfBGX4iJgFg+CMvxEQMAwHwRl+IiACIOhGX4iIAIg4EZfjkQBxBwIy/HJA" type="audio/mpeg">
        </audio>
    </div>
    <script>
        // Variables para manipulación de la casa
        let points = [];
        const pointsOrigin = [
            {x: 200, y: 50},  // Techo
            {x: 300, y: 150}, // Esquina derecha superior
            {x: 300, y: 300}, // Esquina derecha inferior
            {x: 250, y: 300}, // Puerta derecha arriba
            {x: 250, y: 250}, // Puerta derecha abajo
            {x: 150, y: 250}, // Puerta izquierda abajo
            {x: 150, y: 300}, // Puerta izquierda arriba
            {x: 100, y: 300}, // Esquina izquierda inferior
            {x: 100, y: 150}  // Esquina izquierda superior
        ];
        let houseIntegrity = 100;
        let houseBurst = false;
        let inflation = 0;
        let isDragging = false;
        let currentPoint = null;
        let offset = {x: 0, y: 0};
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let animationFrame;
        let currentDragFragment = null;
        let dragOffset = {x: 0, y: 0};

        document.addEventListener('DOMContentLoaded', () => {
            initializeHouse();
            initializeFragments();
            document.getElementById('micPermission').addEventListener('click', setupAudioContext);
        });

        function initializeHouse() {
            const casa = document.getElementById('casa');
            pointsOrigin.forEach((point, index) => {
                const pointElement = document.createElement('div');
                pointElement.className = 'house-point';
                pointElement.style.left = point.x + 'px';
                pointElement.style.top = point.y + 'px';
                pointElement.dataset.index = index;
                pointElement.addEventListener('mousedown', startDrag);
                pointElement.addEventListener('touchstart', startDragTouch, { passive: false });
                casa.appendChild(pointElement);
                points.push({
                    x: point.x,
                    y: point.y,
                    element: pointElement,
                    originalX: point.x,
                    originalY: point.y
                });
            });
            window.addEventListener('mousemove', drag);
            window.addEventListener('mouseup', stopDrag);
            window.addEventListener('touchmove', dragTouch, { passive: false });
            window.addEventListener('touchend', stopDragTouch);
            updateHousePath();
        }

        function startDrag(e) {
            if (houseBurst) return;
            isDragging = true;
            currentPoint = points[parseInt(e.target.dataset.index)];
            offset.x = e.clientX - currentPoint.x;
            offset.y = e.clientY - currentPoint.y;
        }
        function drag(e) {
            if (isDragging && currentPoint && !houseBurst) {
                let x = e.clientX - offset.x;
                let y = e.clientY - offset.y;
                // Limitar dentro del SVG
                x = Math.max(0, Math.min(400, x));
                y = Math.max(0, Math.min(400, y));
                currentPoint.x = x;
                currentPoint.y = y;
                currentPoint.element.style.left = x + 'px';
                currentPoint.element.style.top = y + 'px';
                updateHousePath();
                checkIntegrity();
            }
        }
        function stopDrag() {
            isDragging = false;
            currentPoint = null;
        }
        // Touch
        function startDragTouch(e) {
            if (houseBurst) return;
            e.preventDefault();
            const touch = e.touches[0];
            isDragging = true;
            currentPoint = points[parseInt(e.target.dataset.index)];
            offset.x = touch.clientX - currentPoint.x;
            offset.y = touch.clientY - currentPoint.y;
        }
        function dragTouch(e) {
            if (isDragging && currentPoint && !houseBurst) {
                e.preventDefault();
                const touch = e.touches[0];
                let x = touch.clientX - offset.x;
                let y = touch.clientY - offset.y;
                x = Math.max(0, Math.min(400, x));
                y = Math.max(0, Math.min(400, y));
                currentPoint.x = x;
                currentPoint.y = y;
                currentPoint.element.style.left = x + 'px';
                currentPoint.element.style.top = y + 'px';
                updateHousePath();
                checkIntegrity();
            }
        }
        function stopDragTouch() {
            isDragging = false;
            currentPoint = null;
        }

        function updateHousePath() {
            // Actualiza el SVG de la casa según los puntos
            const d = `M ${points[0].x},${points[0].y} L ${points[1].x},${points[1].y} L ${points[2].x},${points[2].y} L ${points[3].x},${points[3].y} L ${points[4].x},${points[4].y} L ${points[5].x},${points[5].y} L ${points[6].x},${points[6].y} L ${points[7].x},${points[7].y} L ${points[8].x},${points[8].y} Z`;
            document.getElementById('housePath').setAttribute('d', d);
            document.getElementById('houseStitches').setAttribute('d', d);
        }

        function checkIntegrity() {
            // Si algún punto se aleja demasiado de su origen, explota
            for (let i = 0; i < points.length; i++) {
                let dx = points[i].x - points[i].originalX;
                let dy = points[i].y - points[i].originalY;
                if (Math.sqrt(dx*dx + dy*dy) > 120) {
                    burstHouse();
                    break;
                }
            }
        }

        // AUDIO (micrófono)
        function setupAudioContext() {
            document.getElementById('micPermission').style.display = 'none';
            document.getElementById('audioLevel').style.display = 'block';
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 512;
                animateInflation();
            }).catch(() => {
                alert("No se pudo acceder al micrófono.");
            });
        }
        function animateInflation() {
            if (houseBurst) return;
            let dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            let volume = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
            let level = Math.min(1, volume / 60);
            document.getElementById('audioLevelBar').style.height = (level * 100) + 'px';
            inflateHouse(level);
            animationFrame = requestAnimationFrame(animateInflation);
        }
        function inflateHouse(level) {
            // Inflar/desinflar la casa proporcionalmente al audio
            for (let i = 0; i < points.length; i++) {
                let ox = points[i].originalX;
                let oy = points[i].originalY;
                let cx = 200, cy = 200;
                let dx = ox - cx;
                let dy = oy - cy;
                points[i].x = ox + dx * level * 0.5;
                points[i].y = oy + dy * level * 0.5;
                points[i].element.style.left = points[i].x + 'px';
                points[i].element.style.top = points[i].y + 'px';
            }
            updateHousePath();
            if (level > 0.95) burstHouse();
        }

        function burstHouse() {
            if (houseBurst) return;
            houseBurst = true;
            cancelAnimationFrame(animationFrame);
            document.getElementById('popSound').play();
            document.getElementById('casa').style.display = 'none';
            document.getElementById('audioLevel').style.display = 'none';
            showFragments();
        }

        // FRAGMENTOS: Mantener dentro del viewport
        function initializeFragments() {
            const fragments = document.querySelectorAll('.fragments');
            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;
            fragments.forEach((fragment, i) => {
                fragment.style.left = (centerX - 60 + i*110) + 'px';
                fragment.style.top = (centerY - 60 + i*60) + 'px';
                fragment.addEventListener('mousedown', startDragFragment);
                fragment.addEventListener('touchstart', startDragFragmentTouch, { passive: false });
            });
            window.addEventListener('mousemove', dragFragment);
            window.addEventListener('mouseup', stopDragFragment);
            window.addEventListener('touchmove', dragFragmentTouch, { passive: false });
            window.addEventListener('touchend', stopDragFragment);
        }
        function showFragments() {
            document.querySelectorAll('.fragments').forEach(f => f.style.display = 'block');
        }
        function startDragFragment(e) {
            e.preventDefault();
            currentDragFragment = e.target.closest('.fragments');
            dragOffset.x = e.clientX - parseInt(currentDragFragment.style.left);
            dragOffset.y = e.clientY - parseInt(currentDragFragment.style.top);
        }
        function dragFragment(e) {
            if (currentDragFragment) {
                let x = e.clientX - dragOffset.x;
                let y = e.clientY - dragOffset.y;
                // Limitar dentro del viewport
                x = Math.max(0, Math.min(window.innerWidth - 100, x));
                y = Math.max(0, Math.min(window.innerHeight - 100, y));
                currentDragFragment.style.left = x + 'px';
                currentDragFragment.style.top = y + 'px';
            }
        }
        function stopDragFragment() {
